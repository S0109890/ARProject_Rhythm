using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Text;
using UnityEngine;

public class NoteManager : MonoBehaviour
{
    List<NoteInfo> list;
    float currentTime;
    int flowIndex;
    bool isMakeNote;

    public GameObject[] spawns;

    public GameObject noteFactory;
    // Start is called before the first frame update
    void Start()
    {
        list = Loader();
        //for (int i = 0; i < list.Count; i++)
        //{
        //    list[i].Show();
        //}

        isMakeNote = true;
    }

    // Update is called once per frame
    void Update()
    {
        if (isMakeNote == false)
        {
            return;
        }
        // 시간이 흐르다가
        currentTime += Time.deltaTime;
        // 현재시간이 노트를 만들 시간되면
        print(list[flowIndex].time);
        if (currentTime >= list[flowIndex].time)
        {
            // 노트를 만들고
            GameObject note = Instantiate(noteFactory);
            note.transform.position = spawns[list[flowIndex].noteIndex].transform.position;
            // 다음 노트 만들시간을 목표로 가게 하고싶다.
            flowIndex++;
            // 만약 더이상 만들 노트가 없으면 멈추고싶다. 
            if (flowIndex >= list.Count)
            {
                // 스톱!
                isMakeNote = false;
            }
        }
    }
    public TextAsset noteText;
    List<NoteInfo> Loader()
    {
        List<NoteInfo> result = new List<NoteInfo>();
        string textss = noteText.text.Replace("\r", ""); // 보험
        string[] strings = textss.Split('\n'); // 줄바꿈으로 다음 줄 불러오기
        for (int i = 0; i < strings.Length; i++) //0부터 전체 길이까지 한 줄씩 불러온다.
        {
            NoteInfo noteInfo = new NoteInfo();
            noteInfo.Parse(strings[i]);
            result.Add(noteInfo);
        }

        return result;
    }

}

public class NoteInfo
{
    public int noteIndex;
    public float time;
    public int noteType;

    string info;

    public void Parse(string info) // parse = 문자열을 숫자로 변환시키기 위함
    {
        this.info = info;
        string[] s = info.Split(','); // ','로 구별
        int.TryParse(s[0], out noteIndex); // 결과값을 noteIndex에 저장하라

        if (noteIndex == 42) noteIndex = 0;
        else if (noteIndex == 64) noteIndex = 0;
        else if (noteIndex == 128) noteIndex = 1;
        else if (noteIndex == 192) noteIndex = 2;
        else if (noteIndex == 213) noteIndex = 2;
        else if (noteIndex == 320) noteIndex = 3;
        else if (noteIndex == 298) noteIndex = 3;
        else if (noteIndex == 384) noteIndex = 4;
        else if (noteIndex == 469) noteIndex = 5;
        else if (noteIndex == 448) noteIndex = 5;

        float.TryParse(s[2], out time);
        time /= 1000f;
        int.TryParse(s[3], out noteType);
    }

    public void Show() //print가 안되므로 log출력
    {
        Debug.Log(info);
    }

}